[Unit]
Description=Certificate Syncer
After=network-online.target
Wants=network-online.target
After=setup-certificate-syncer.service
BindsTo=setup-certificate-syncer.service

[Service]
LogRateLimitIntervalSec=1ms
LogRateLimitBurst=1000
User=root
Group=root
Restart=always
EnvironmentFile=/run/ic-node/etc/default/certificate-syncer
ExecStart=/bin/bash -c '                                                                      \
    /opt/ic/bin/certificate-syncer                                                            \
        --certificates-exporter-uri   "http://localhost:3000/certificates"                    \
        --local-certificates-path     "/var/opt/nginx/certs"                                  \
        --local-configuration-path    "/var/opt/nginx/domains.conf"                           \
        --configuration-template-sw-path "/etc/certificate-syncer/domain-with-sw.tmpl"        \
        --configuration-template-no-sw-path "/etc/certificate-syncer/domain-without-sw.tmpl"  \
        ${RAW_DOMAINS_PATH:+          --no-sw-domains-path       "${RAW_DOMAINS_PATH}"}       \
        --domain-mappings-path        "/var/opt/nginx/domain_canister_mappings.js"            \
        --metrics-addr                "[::]:9322"                                             \
        ${POLLING_INTERVAL_SEC:+      --polling-interval-sec    "${POLLING_INTERVAL_SEC}"}    \
'

[Install]
WantedBy=multi-user.target
