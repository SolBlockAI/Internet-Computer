server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    server_name .rosetta.dfinity.network;
    include "/run/ic-node/etc/nginx/conf.d/server_rosetta_domain.conf";

    include "includes/whitelist_rosetta.conf";

    location ~ (/api/v2/status|/health) {
        # Observability
        include "includes/request_id.conf";

        # Prereqs
        include "includes/method_get.conf";

        # Proxy
        proxy_pass "http://ic_boundary";
        include "includes/proxy_x_request_id.conf";
        include "includes/proxy_keepalive.conf";
        include "includes/secure_headers.conf";
    }

    location ~ /api/v2/canister/[0-9a-zA-Z\-]+/query {
        # Observability
        include "includes/request_id.conf";

        # Prereqs
        include "includes/method_post.conf";

        # Proxy
        proxy_pass "http://ic_boundary";
        include "includes/proxy_x_request_id.conf";
        include "includes/proxy_keepalive.conf";
        include "includes/secure_headers.conf";
    }

    location ~ /api/v2/canister/[0-9a-zA-Z\-]+/call {
        # Observability
        include "includes/request_id.conf";

        # Prereqs
        include "includes/method_post.conf";

        # Proxy
        proxy_pass "http://ic_boundary";
        include "includes/proxy_x_request_id.conf";
        include "includes/proxy_keepalive.conf";
        include "includes/secure_headers.conf";
    }

    location ~ /api/v2/canister/[0-9a-zA-Z\-]+/read_state {
        # Observability
        include "includes/request_id.conf";

        # Prereqs
        include "includes/method_post.conf";

        # Proxy
        proxy_pass "http://ic_boundary";
        include "includes/proxy_x_request_id.conf";
        include "includes/proxy_keepalive.conf";
        include "includes/secure_headers.conf";
    }

    location / {
        # Observability
        include "includes/request_id.conf";

        # Limits
        limit_req zone=http_zone burst=5000 delay=2000;
        limit_req zone=http_remote_addr_zone burst=200 delay=200;

        proxy_pass "http://icx_proxy";
        include "includes/proxy_headers.conf";
    }
}
